<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Practical tools to make data research easier and better</title>
    <meta charset="utf-8" />
    <meta name="author" content="@kevin_kunzmann" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Practical tools to make data research easier and better
## ESICM Tech Lounge
### <span class="citation">@kevin_kunzmann</span>
### MRC-BSU, University of Cambridge
### 2019/09/30

---

class: inverse, middle



# Who am I?

* Mathematician/Statistician with keen interest in 'Data Science' and (deep) machine learning

* Worked several years as analyst in two multi-centric studies: 4C and CENTER-TBI

* Convinced that open science/source is the future

* Sometimes frustrated by the adoption of modern *tooling* in academia





---
class: inverse, middle
# Outline

1. Where are we headed? 

2. Data, Data, Data!

2. Literate Programming

3. Workflow Management

4. Version Control and Collaboration

5. Dependency Management

6. Demo





---
# Data research as software development

- modern empricial research is **highly data-driven**

- **multiple stake-holders** (analysts, non-tech experts)

- anything beyond absolute basics: **complex analysis scripts**

- **agile development** (changing requirements/hypotheses)

- quality control - **reproducibility?**





---
class: inverse, middle

&gt; *Data research is essentially about writing a piece of software that
turns data into a manuscript. &lt;br&gt; &lt;br&gt; `\(\leadsto\)` Be smart, adopt lessons learnt from software develoment!*



---

.pull-left[

## Reproducible Research

- **credibility/transparency**

- code **re-usability**

- easier **modification/extension**

- facilitates **passing on projects** to others

- easier in the **long run**

]

.pull-right[

## Open Science

- **sharing** results

- independent of reproducibility

- easy data access (minimal restrictions) 

- adds value to reprodicible analysis 

- funding requirement (FAIR)

]

### References

- online WiP compendium on OS &amp; RR: [The Turing Way](https://the-turing-way.netlify.com/introduction/introduction)

- info about [FAIR](https://www.go-fair.org/fair-principles/) (Findable, Accessible, Interoperable, Reusable)


---
class: inverse, middle
# 'Data is the new oil'



---
# 'Data is the new oil' - but...

.pull-left[

&lt;img src="figures/cash.jpg" height="200px"&gt; 

- valuable

- basis for everything we do

]

.pull-right[

&lt;img src="figures/deepwater.jpg" height="200px"&gt; 

- must be handled with care 

- sticky if raw, must be processed (curated)

- requires huge infrastructure + maintainance

]




---
# Data management considerations

- have a plan and **involve domain experts, early**!

- make sure data bases are **flexible** to adapt to **changing requirements**

- think about storage of **intermediate data products**

- make sure everything is **accessible in a systematic way** 
  * REST API access?
  * permission system/privacy?

- provide metadata: units, descriptions, labels

- ensure continuous **support/maintainance over the entire project timeline**

- put more effort and money in **data curation/quality control**!

- complex data bases evolve over time, provide **versioned access** to data?





---
class: inverse, middle
# 'Literate Programming'

&gt; *"I believe that the time is ripe for significantly better documentation of 
programs, and that we can best achieve this by considering programs to be works
of literature. Hence, my title: 'Literate Programming'."* Donald Knuth, 1984





---
# Literate Programming

- script file with code + comments: **ugly**, no output

- 'literate program': **code, output, and documentation are equally** important

- prime example 'notebooks' (**Jupyter Notebook**): 
  - **interactive** cell-style programming
  - text can be authored with **markdown**
  - can be **exported** to .pdf/.html/...




---
class: inverse, middle
# Demo: Jupyter Notebook

1. go to [**`https://bit.ly/2mAyOxn`**](https://bit.ly/2mAyOxn)

2. execute code 'chunks' (focus and shift + enter)

3. export via `File/Export notebook as`





---
# Notebooks

.pull-left[

## Pros

1. mix text/output with code

2. export to multiple formats

3. interactive coding style 

4. support most common scripting languages

]

.pull-right[

## Cons

1. plain notebook file not human-readable (json metadata)

2. interactivity: order-of-execution errors

3. limited formatting flexibility

]





---
class: inverse, middle
# markdown + knitr + pandoc




---
# Literate programming with code-chunks

- this presentation is authored in markdown (`slides.Rmd`)!

- easy to use

- source document is readable even with just a text editor

- rich output with templates

### Process:

1. combine markdown text with code in 'chunks'
2. run code chunks with appropriate scripting language (knitr)
3. capture output (text/figures) in extended markdown file (knitr)
4. convert to desired output format using pandoc (allows templates!)








---

.pull-left[

## Input markdown + code

````
Some text
```{r demo-chunk}
plot(cars)
```
````

]

.pull-right[

## Output (html)

Some text
![](slides_files/figure-html/unnamed-chunk-1-1.png)&lt;!-- --&gt;

]






---
class: inverse, middle
# Demo

1. go to **`https://bit.ly/2nAlE3v`**

2. open file `report.Rmd`

3. 'knit' it (button above .Rmd file)





---
class: inverse, middle
# Workflow Automation





---
# Workflows

- complex analyses often require **multiple outputs** (plots, tables, reports)

- often **intermediate files** (data sets)

- **interdependent steps**, need to maintain right **order of execution**

- difficult to update everything if something changes early on

- long running steps should not be run multiple times



### Solution: Workflow automation

- analysis = program mapping **data `\(\to\)` outputs**

- represent **path from data to output as directed (acyclic) graph (DAG)**

- only execute necessary steps, **cache intermediates**




---
# Example: snakemake

- python tool inspired by GNU make

- python-like syntax, easy to learn

- represents workflows as DAGs

- automatically caching

- can run independent steps in parallel 

- High Performance Computing (HPC) support via slurm

- individual steps can be run in containers via singularity




---
class: inverse, middle
# Demo

1. go to [**`https://bit.ly/2lXMiTg`**](https://bit.ly/2lXMiTg)

2. have a look at the `Snakefile`

3. open a new terminal window

4. execute `snakemake --dag | dot -Tpdf &gt; dag.pdf` 

5. open the file `dag.pdf`

6. execute the command `snakemake`

7. execute the command again!

8. delete the folder `mnist` and execute again




---
class: middle, inverse
# Version Control

---
# Version Control - git/GitHub


.pull-left[

## git

* **command line tool**, VCS [1]

* VCS = **'project time machine'**

* versions are cryptographically locked (**immutable**)

* **distributed** (no central server, encourages collaboration)

* **the** standard VCS

]

.pull-right[

## Github/GitLab/etc.

* code hosting

* web services to make `git` more usable

* collaboration features (issues, projects, ...)

]

&lt;br&gt;

.footnote[
[1] VCS = Version Control System
]



---
# Example: this workshop!

- https://github.com/kkmann/esicm-2019-data-research-tools

- visit, look around

- please, do raise issues with feedback/suggestions/questions

- pull requests welcome!

### Not enough time for in-depth git x(

- [#TheTuringWay/version_control](https://the-turing-way.netlify.com/version_control/version_control.html)

- [#TheTuringWay/collaborating_github](https://the-turing-way.netlify.com/collaborating_github/collaborating_github.html)




---
class: inverse, middle
# Dependency Management



---
# Software Dependencies

- we have:
  * literate programs/reports
  * automated workflow
  * everything under version control

- what could go wrong?

- lots of software dependencies (R/Python/tensorflow/snakemake/LaTeX/...)

- open source software evolves quickly 

- need to 'freeze' entire computing framework

- package managers only work with pre-existing packages, trouble capturing 
system-level dependencies




---
# Solution: Containerization (with singularity)

- better: isolate everything above the raw operating system (linux!)

- think: lightweight virtual machine 

- no 'hard drive'

- no hardware virtualization (use host system) - fast!

- images are single files, easily sharable!
  
- those must be complicated...





---
# Singularity Definition File

```
Bootstrap: docker
From: rocker/verse:latest

%post
apt-get update
apt-get -y install python3-pip

python3 -m pip install \
    jupyter nbconvert \
    numpy tensorflow keras \
    virtualenv \
    snakemake
    
export JUPYTER_CONFIG_DIR=/usr/local/etc/jupyter/
export JUPYTER_PATH=/usr/local/share/jupyter/

R -e "install.packages(c('IRkernel', 'tensorflow'))"
R -e "IRkernel::installspec(prefix = '/usr/local', user = FALSE)"
R -e "tensorflow::install_tensorflow()"
R -e "install.packages(c('xaringan', 'reticulate', 'tidyverse'))"
```
  
---
class: inverse, middle
# ... and what about building those?


```bash
singularity build container.sif container.def
```

- that's it!

- creates single file `container.sif` that can be shared

- install singularity, requires linux (virtual machine?)

- our container is stored at https://zenodo.org/record/3464160
  
  
---
 
.pull-left[

## Docker

* made containers 'sexy'

* widely used by industry to run microservices

* requires **root access to build and run** &lt;br&gt; `\(\leadsto\)` incompatible with HPC

* not intended/suitable for scientific purposes

]

.pull-right[

## Singularity

* 'Docker for HPC'

* **root only for building**! &lt;br&gt; `\(\leadsto\)` compatible with HPC

* reproducible, portable computing environment - run 
arbitrary software on your HPC without bothering your admin! 

* integrates with workflow management engines (snakemake, nextflow, etc.) and
HPC

]



---
class: inverse, middle
# Demo

- nested containers are not a good idea

- our interactive seesions run in containers

- cannot provide interactive demo, install singularity and try at home!

- here: quick demo on our HPC


---
class: middle, center
# HPC Demo



---
class: inverse
# Summary

- No free lunch: 'Data Research' is complex!

- 'Data Research' is software development, be smart and use their tools!

- Reproducibility of complex analyses paramount to enable thorough review and reuse!

- Literate programming can ease analyst/investigator communication by 
streamlining reliable report generation

- Data hosting + code hosting + containerization + version control can facilitate
collaboration on complex projects

- Better code quality `\(\leadsto\)` more enjoyable coding + more confidence in
results
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
